<template>
    <div class="leading-tight">
        <ul v-if="hasResource" class="list-reset flex flex-wrap product-variant-list justify-between">
            <li  class="rounded-lg overflow-hidden mb-3" style="height:100px;" v-for="item in lists" :key="lists.id">
                <select-product-variant-list-item :channelId="channelId" @change="itemChange" :selections="value"
                                           :resource="item"></select-product-variant-list-item>
            </li>
            <infinite-loading :identifier="infiniteId" @infinite="infiniteHandler">
            </infinite-loading>
        </ul>
        <div v-else class="card-no-shadow flex flex-col items-center justify-center" style="min-height: 300px">
            <svg class="spin fill-80 mb-6" width="69" height="72" viewBox="0 0 23 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M20.12 20.455A12.184 12.184 0 0 1 11.5 24a12.18 12.18 0 0 1-9.333-4.319c4.772 3.933 11.88 3.687 16.36-.738a7.571 7.571 0 0 0 0-10.8c-3.018-2.982-7.912-2.982-10.931 0a3.245 3.245 0 0 0 0 4.628 3.342 3.342 0 0 0 4.685 0 1.114 1.114 0 0 1 1.561 0 1.082 1.082 0 0 1 0 1.543 5.57 5.57 0 0 1-7.808 0 5.408 5.408 0 0 1 0-7.714c3.881-3.834 10.174-3.834 14.055 0a9.734 9.734 0 0 1 .03 13.855zM4.472 5.057a7.571 7.571 0 0 0 0 10.8c3.018 2.982 7.912 2.982 10.931 0a3.245 3.245 0 0 0 0-4.628 3.342 3.342 0 0 0-4.685 0 1.114 1.114 0 0 1-1.561 0 1.082 1.082 0 0 1 0-1.543 5.57 5.57 0 0 1 7.808 0 5.408 5.408 0 0 1 0 7.714c-3.881 3.834-10.174 3.834-14.055 0a9.734 9.734 0 0 1-.015-13.87C5.096 1.35 8.138 0 11.5 0c3.75 0 7.105 1.68 9.333 4.319C16.06.386 8.953.632 4.473 5.057z"
                      fill-rule="evenodd"/>
            </svg>
            <h1 class="text-4xl text-80 font-light">
                暂无商品
            </h1>
        </div>
    </div>
</template>

<script>
  import Pageable from '../../pageable'
  import InfiniteLoading from 'vue-infinite-loading'

  export default {
    name: 'select-product-variant-list',

    mixins: [Pageable],

    components: {
      InfiniteLoading
    },
    props: {
      defaultValue: {
        type: Array,
        default: () => []
      },
      channelId:{
        type: [String, Number]
      },
      supplierId: {
        type: [String, Number]
      },
      uriKey: {
        type: String
      },
    },
    data () {
      return {
        response: {},
        loading: false,
        value: [],
        lists: [],
        infiniteId: +new Date(),
      }
    },
    watch: {
      value: {
        handler: function (value) {
          this.$emit('change', value)
        }
      },
      supplierId: async function (value) {
        if (value) {
          this.currentPage = 1
          this.lists = []
          this.infiniteId += 1
          await this.fetchVariants()
        }
      }
    },
    methods: {
      initValue (value) {
        this.value = value
      },
      isChecked (resource) {
        return this.selections.includes(resource)
      },
      itemChange (resource) {
        const index = this.value.findIndex(item => item.id === resource.id)
        if (index >= 0) {
          this.value.splice(index, 1)
        } else {
          this.value.push(resource)
        }
      },
      fetchVariants () {
        this.loading = true
        return axios.get(`/${this.uriKey}`, {params: this.apiParams}).then(({data}) => {
          this.response = data
          data.current_page++
          this.lists = data.data
          this.setOptions(data)
          this.loading = false
        })
      },
      infiniteHandler ($state) {
        axios.get(`/${this.uriKey}`, {params: this.apiParams})
          .then(({data}) => {
            this.response = data
            data.current_page++
            this.setOptions(data)
            this.lists.push(...data.data)
            if (data.next_page_url) {
              $state.loaded()
            } else {
              $state.complete()
            }
          })
      },
    },
    computed: {
      hasResource () {
        return (_.get(this, 'lists', [])).length > 0
      },
      apiParams () {
        return Object.assign({}, {
          supplier: this.supplierId,
          search: this.query,
          page: this.currentPage,
          include:'dpPrices',
          channel:this.channelId
        })
      }
    },
    mounted () {
      this.initValue(this.defaultValue)
    }
  }
</script>

<style scoped>
    .product-variant-list li {
        width: 30%;
    }
</style>